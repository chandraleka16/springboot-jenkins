def gitRepoName = "https://github.com/chandraleka16/springboot-jenkins.git"

def customLocalImage = "springboot-app"

def dockerPublisherName = "chandraleka1403"
def dockerRepoName = "springboot-app"

properties([pipelineTriggers([githubPush()])])

pipeline {
    agent {
        node {
            label 'slave2'
        }
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: "**", url: "${gitRepoName}"
                script {
                    branch = "${GIT_BRANCH}".split('/')[0]
                }
                echo "CHECKING OUT BRANCH:${branch}"
            }
        }

        stage('Build') {
            steps {
                script {
                    if (branch.contains('release') || branch == 'master'){
                        
                        sh "docker rmi ${customLocalImage} || true"
                        sh "docker build -t ${customLocalImage} ."
                        echo "Build Successul"
                    } else if (branch == 'qa' || branch == 'develop') {
                        echo "It is a ${branch} branch"
                    } else if (gitBranch.contains('feature')) {
                        echo "It is a ${branch} branch"
                    }
                }
            }
        }

        stage('Publish') {
            steps {
                script {
                    if (branch.contains('release')){
                        def gitTag = "build-${BUILD_NUMBER}"
                        def gitUrl = "https://chandraleka16:Mano3Logesh@github.com/chandraleka16/springboot-jenkins.git"

                        sh "git tag ${gitTag}"
                        sh "git push ${gitUrl} ${gitTag}"
                        def ECR_URL="853973692277.dkr.ecr.us-east-1.amazonaws.com"
                        def ECR_REPO="ac-devops-training"
                        //withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: '	aws-ecr-credentials', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                            // some block
                        sh("eval \$(aws ecr get-login --no-include-email --region us-east-1 | sed 's|https://||')")
                       //sh "`aws ecr get-login --no-include-email --region us-east-1`"
                        sh "docker tag ${customLocalImage} ${ECR_URL}/${ECR_REPO}:${gitTag}"
                        sh "docker tag ${customLocalImage} ${ECR_URL}/${ECR_REPO}:latest"
                        echo "${ECR_URL}/${ECR_REPO}"
                        sh "docker push ${ECR_URL}/${ECR_REPO}:latest"
                       //}
                    } else if (branch == 'master') {
                        sh "docker tag ${customLocalImage} ${dockerPublisherName}/${dockerRepoName}:build-${BUILD_NUMBER}"
                        sh "docker tag ${customLocalImage} ${dockerPublisherName}/${dockerRepoName}:latest"
                        sh "docker push ${dockerPublisherName}/${dockerRepoName}"
                    } else if (branch == 'develop') {
                        echo "It is a ${branch} branch"
                    } else if (branch.contains('feature')) {
                        echo "It is a ${branch} branch"
                    }
                }
            }
        }
    }
}

